{
  "annotations": { "list": [] },
  "description": "Aurora DSQL persistence metrics",
  "editable": true,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "panels": [
    { "id": 1, "type": "row", "title": "Connections", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 }, "collapsed": false, "panels": [] },

    {
      "id": 2, "type": "stat", "title": "Available",
      "description": "Connections ready for use",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 4, "w": 4, "x": 0, "y": 1 },
      "fieldConfig": { "defaults": { "unit": "short", "thresholds": { "mode": "absolute", "steps": [{ "color": "red", "value": null }, { "color": "yellow", "value": 10 }, { "color": "green", "value": 30 }] } } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(dsql_reservoir_size) or sum(dsql_pool_idle) or vector(0)" }]
    },
    {
      "id": 3, "type": "stat", "title": "In Use",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 4, "w": 4, "x": 4, "y": 1 },
      "fieldConfig": { "defaults": { "unit": "short", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] } } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(dsql_pool_in_use) or vector(0)" }]
    },
    {
      "id": 4, "type": "stat", "title": "Checkout p95",
      "description": "Should be <1ms",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 4, "w": 4, "x": 8, "y": 1 },
      "fieldConfig": { "defaults": { "unit": "ms", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 10 }] } } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "histogram_quantile(0.95, sum by (le) (rate(dsql_reservoir_checkout_latency_milliseconds_bucket[1m])))" }]
    },
    {
      "id": 5, "type": "stat", "title": "Refills/min",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 4, "w": 4, "x": 12, "y": 1 },
      "fieldConfig": { "defaults": { "unit": "short", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] } } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(rate(dsql_reservoir_refills_total[1m])) * 60 or vector(0)" }]
    },
    {
      "id": 6, "type": "stat", "title": "Empty Events",
      "description": "Should be 0",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 4, "w": 4, "x": 16, "y": 1 },
      "fieldConfig": { "defaults": { "unit": "short", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 1 }, { "color": "red", "value": 10 }] } } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
      "targets": [{ "refId": "A", "expr": "sum(increase(dsql_reservoir_empty_total[5m])) or vector(0)" }]
    },

    {
      "id": 7, "type": "stat", "title": "Target",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 4, "w": 4, "x": 20, "y": 1 },
      "fieldConfig": { "defaults": { "unit": "short", "thresholds": { "mode": "absolute", "steps": [{ "color": "blue", "value": null }] } } },
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "none" },
      "targets": [{ "refId": "A", "expr": "sum(dsql_reservoir_target) or sum(dsql_pool_max_open) or vector(0)" }]
    },

    {
      "id": 8, "type": "timeseries", "title": "Reservoir Size",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 5 },
      "fieldConfig": { "defaults": { "unit": "short", "custom": { "showPoints": "never" } }, "overrides": [
        { "matcher": { "id": "byName", "options": "target" }, "properties": [{ "id": "custom.lineStyle", "value": { "fill": "dash" } }, { "id": "color", "value": { "fixedColor": "blue", "mode": "fixed" } }] },
        { "matcher": { "id": "byName", "options": "size" }, "properties": [{ "id": "color", "value": { "fixedColor": "green", "mode": "fixed" } }] }
      ] },
      "targets": [
        { "refId": "A", "expr": "sum(dsql_reservoir_target)", "legendFormat": "target" },
        { "refId": "B", "expr": "sum(dsql_reservoir_size)", "legendFormat": "size" }
      ]
    },
    {
      "id": 9, "type": "timeseries", "title": "Checkout Latency",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 5 },
      "fieldConfig": { "defaults": { "unit": "ms", "custom": { "showPoints": "never" } } },
      "targets": [
        { "refId": "A", "expr": "histogram_quantile(0.50, sum by (le) (rate(dsql_reservoir_checkout_latency_milliseconds_bucket[1m])))", "legendFormat": "p50" },
        { "refId": "B", "expr": "histogram_quantile(0.95, sum by (le) (rate(dsql_reservoir_checkout_latency_milliseconds_bucket[1m])))", "legendFormat": "p95" },
        { "refId": "C", "expr": "histogram_quantile(0.99, sum by (le) (rate(dsql_reservoir_checkout_latency_milliseconds_bucket[1m])))", "legendFormat": "p99" }
      ]
    },
    {
      "id": 10, "type": "timeseries", "title": "Refills & Checkouts",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 11 },
      "fieldConfig": { "defaults": { "unit": "ops", "custom": { "showPoints": "never" } } },
      "targets": [
        { "refId": "A", "expr": "sum(rate(dsql_reservoir_checkouts_total[1m]))", "legendFormat": "checkouts/sec" },
        { "refId": "B", "expr": "sum(rate(dsql_reservoir_refills_total[1m]))", "legendFormat": "refills/sec" },
        { "refId": "C", "expr": "sum(rate(dsql_reservoir_empty_total[1m]))", "legendFormat": "empty/sec" }
      ]
    },
    {
      "id": 11, "type": "timeseries", "title": "Discards",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 11 },
      "fieldConfig": { "defaults": { "unit": "ops", "custom": { "showPoints": "never" } } },
      "targets": [{ "refId": "A", "expr": "sum by (reason) (rate(dsql_reservoir_discards_total[1m]))", "legendFormat": "{{reason}}" }]
    },

    { "id": 20, "type": "row", "title": "Persistence", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 17 }, "collapsed": false, "panels": [] },

    {
      "id": 21, "type": "timeseries", "title": "Latency by Operation (p95)",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 18 },
      "fieldConfig": { "defaults": { "unit": "ms", "custom": { "showPoints": "never" } } },
      "options": { "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean", "max"] } },
      "targets": [{ "refId": "A", "expr": "topk(8, histogram_quantile(0.95, sum by (operation, le) (rate(persistence_latency_milliseconds_bucket[5m]))))", "legendFormat": "{{operation}}" }]
    },
    {
      "id": 22, "type": "timeseries", "title": "Request Rate",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 18 },
      "fieldConfig": { "defaults": { "unit": "ops", "custom": { "showPoints": "never" } } },
      "options": { "legend": { "displayMode": "table", "placement": "right", "calcs": ["mean"] } },
      "targets": [{ "refId": "A", "expr": "topk(8, sum by (operation) (rate(persistence_requests_total[1m])))", "legendFormat": "{{operation}}" }]
    },
    {
      "id": 23, "type": "timeseries", "title": "Errors",
      "datasource": { "type": "prometheus", "uid": "prometheus" },
      "gridPos": { "h": 6, "w": 24, "x": 0, "y": 26 },
      "fieldConfig": { "defaults": { "unit": "ops", "custom": { "showPoints": "never" } } },
      "targets": [
        { "refId": "A", "expr": "sum by (operation) (rate(persistence_errors_total[1m]))", "legendFormat": "{{operation}}" },
        { "refId": "B", "expr": "sum by (error_type) (rate(persistence_error_with_type_total[1m]))", "legendFormat": "{{error_type}}" }
      ]
    },

    { "id": 30, "type": "row", "title": "OCC Conflicts", "gridPos": { "h": 1, "w": 24, "x": 0, "y": 32 }, "collapsed": true, "panels": [
      {
        "id": 31, "type": "stat", "title": "Conflicts/sec",
        "datasource": { "type": "prometheus", "uid": "prometheus" },
        "gridPos": { "h": 4, "w": 6, "x": 0, "y": 33 },
        "fieldConfig": { "defaults": { "unit": "ops", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 10 }, { "color": "red", "value": 50 }] }, "noValue": "0" } },
        "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
        "targets": [{ "refId": "A", "expr": "sum(rate(dsql_tx_conflict_total[1m])) or vector(0)" }]
      },
      {
        "id": 32, "type": "stat", "title": "Retries/sec",
        "datasource": { "type": "prometheus", "uid": "prometheus" },
        "gridPos": { "h": 4, "w": 6, "x": 6, "y": 33 },
        "fieldConfig": { "defaults": { "unit": "ops", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 20 }, { "color": "red", "value": 100 }] }, "noValue": "0" } },
        "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
        "targets": [{ "refId": "A", "expr": "sum(rate(dsql_tx_retry_total[1m])) or vector(0)" }]
      },
      {
        "id": 33, "type": "stat", "title": "Exhausted",
        "description": "Should be 0",
        "datasource": { "type": "prometheus", "uid": "prometheus" },
        "gridPos": { "h": 4, "w": 6, "x": 12, "y": 33 },
        "fieldConfig": { "defaults": { "unit": "ops", "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 0.1 }] }, "noValue": "0" } },
        "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "area" },
        "targets": [{ "refId": "A", "expr": "sum(rate(dsql_tx_exhausted_total[1m])) or vector(0)" }]
      },
      {
        "id": 34, "type": "timeseries", "title": "Conflicts Over Time",
        "datasource": { "type": "prometheus", "uid": "prometheus" },
        "gridPos": { "h": 6, "w": 24, "x": 0, "y": 37 },
        "fieldConfig": { "defaults": { "unit": "ops", "custom": { "showPoints": "never" } } },
        "targets": [
          { "refId": "A", "expr": "sum(rate(dsql_tx_conflict_total[1m]))", "legendFormat": "conflicts" },
          { "refId": "B", "expr": "sum(rate(dsql_tx_retry_total[1m]))", "legendFormat": "retries" },
          { "refId": "C", "expr": "sum(rate(dsql_tx_exhausted_total[1m]))", "legendFormat": "exhausted" }
        ]
      }
    ]}
  ],
  "refresh": "10s",
  "schemaVersion": 39,
  "tags": ["temporal", "dsql"],
  "templating": { "list": [] },
  "time": { "from": "now-15m", "to": "now" },
  "timezone": "browser",
  "title": "DSQL Persistence",
  "uid": "dsql-persistence",
  "version": 1
}