version: '3.8'

services:
  # History service - starts first
  temporal-history:
    container_name: temporal-dsql-history
    image: temporal-dsql-runtime:test
    command: ["--config-file", "/etc/temporal/config/persistence-dsql.yaml", "--allow-no-auth", "start", "--service", "history"]
    env_file:
      - .env.integration
    volumes:
      - ~/.aws:/home/temporal/.aws:ro
      - ./dynamicconfig:/etc/temporal/config/dynamicconfig:ro
    environment:
      - AWS_EC2_METADATA_DISABLED=true
      - TEMPORAL_PERSISTENCE_TEMPLATE=/etc/temporal/config/persistence-dsql-multiservice.template.yaml
    ports:
      - "7234:7234"  # gRPC
      - "6934:6934"  # Membership
    networks:
      - temporal-network
    restart: on-failure

  # Matching service - depends on history
  temporal-matching:
    container_name: temporal-dsql-matching
    image: temporal-dsql-runtime:test
    depends_on:
      - temporal-history
    command: ["--config-file", "/etc/temporal/config/persistence-dsql.yaml", "--allow-no-auth", "start", "--service", "matching"]
    env_file:
      - .env.integration
    volumes:
      - ~/.aws:/home/temporal/.aws:ro
      - ./dynamicconfig:/etc/temporal/config/dynamicconfig:ro
    environment:
      - AWS_EC2_METADATA_DISABLED=true
      - TEMPORAL_PERSISTENCE_TEMPLATE=/etc/temporal/config/persistence-dsql-multiservice.template.yaml
    ports:
      - "7235:7235"  # gRPC
      - "6935:6935"  # Membership
    networks:
      - temporal-network
    restart: on-failure

  # Frontend service - depends on matching
  temporal-frontend:
    container_name: temporal-dsql-frontend
    image: temporal-dsql-runtime:test
    depends_on:
      - temporal-matching
    command: ["--config-file", "/etc/temporal/config/persistence-dsql.yaml", "--allow-no-auth", "start", "--service", "frontend"]
    env_file:
      - .env.integration
    volumes:
      - ~/.aws:/home/temporal/.aws:ro
      - ./dynamicconfig:/etc/temporal/config/dynamicconfig:ro
    environment:
      - AWS_EC2_METADATA_DISABLED=true
      - TEMPORAL_PERSISTENCE_TEMPLATE=/etc/temporal/config/persistence-dsql-multiservice.template.yaml
    ports:
      - "7233:7233"  # gRPC
      - "8233:8233"  # HTTP
      - "6933:6933"  # Membership
    networks:
      - temporal-network
    restart: on-failure
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "7233"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Worker service - depends on frontend
  temporal-worker:
    container_name: temporal-dsql-worker
    image: temporal-dsql-runtime:test
    depends_on:
      - temporal-frontend
    command: ["--config-file", "/etc/temporal/config/persistence-dsql.yaml", "--allow-no-auth", "start", "--service", "worker"]
    env_file:
      - .env.integration
    volumes:
      - ~/.aws:/home/temporal/.aws:ro
      - ./dynamicconfig:/etc/temporal/config/dynamicconfig:ro
    environment:
      - AWS_EC2_METADATA_DISABLED=true
      - TEMPORAL_PERSISTENCE_TEMPLATE=/etc/temporal/config/persistence-dsql-multiservice.template.yaml
    ports:
      - "7239:7239"  # gRPC (worker service port)
      - "6939:6939"  # Membership
    networks:
      - temporal-network
    restart: on-failure

  # Temporal UI
  temporal-ui:
    container_name: temporal-dsql-ui
    image: temporalio/ui:latest
    depends_on:
      - temporal-frontend
    environment:
      - TEMPORAL_ADDRESS=temporal-frontend:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:8080
    ports:
      - "8080:8080"
    networks:
      - temporal-network
    restart: unless-stopped

networks:
  temporal-network:
    external: true